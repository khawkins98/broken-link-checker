{"version":3,"file":"request.js","names":["_reasons","require","_httpMethodsConstants","_isurl","_interopRequireDefault","_got","obj","__esModule","default","ERROR_EVENT","REDIRECT_EVENT","RESPONSE_EVENT","createRequest","url","auth","method","options","isRetry","Promise","resolve","reject","redirects","streamHTTP","stringifyAuth","headers","userAgent","customHeaders","rejectUnauthorized","retry","throwHttpErrors","on","stream","push","simplifyResponse","response","HEAD","retryHeadFail","retryHeadCodes","includes","status","GET","statusCode","statusMessage","statusText","URL","password","username","_default","cache","isURL","TypeError","BLC_INVALID","promise","cacheResponses","cachedPromise","then","set","forEach","redirect","i","subsequentRedirects","slice","catch","error","exports","module"],"sources":["../../../lib/internal/http-protocol/request.js"],"sourcesContent":["import {BLC_INVALID} from \"../reasons\";\nimport {GET, HEAD} from \"http-methods-constants\";\nimport isURL from \"isurl\";\nimport {stream as streamHTTP} from \"got\";\n\n\n\nconst ERROR_EVENT = \"error\";\nconst REDIRECT_EVENT = \"redirect\";\nconst RESPONSE_EVENT = \"response\";\n\n\n\n/**\n * Create an HTTP request.\n * @param {URL} url\n * @param {object} auth\n * @param {string} method\n * @param {object} options\n * @param {boolean} [isRetry]\n * @returns {Promise<object>}\n */\nconst createRequest = (url, auth, method, options, isRetry=false) => new Promise((resolve, reject) =>\n{\n\tconst redirects = [];\n\n\tstreamHTTP(url,\n\t{\n\t\tauth: stringifyAuth(url, auth),\n\t\theaders: { \"user-agent\":options.userAgent, ...options.customHeaders },\n\t\tmethod,\n\t\trejectUnauthorized: false,  // accept self-signed SSL certificates\n\t\tretry: 0,\n\t\tthrowHttpErrors: false\n\t})\n\t.on(ERROR_EVENT, reject)\n\t// @todo test http 303\n\t// @todo http 301/302 requests *can* have bodies, which could have links\n\t.on(REDIRECT_EVENT, stream => redirects.push( simplifyResponse(stream) ))\n\t.on(RESPONSE_EVENT, stream =>\n\t{\n\t\tconst response = simplifyResponse(stream, redirects);\n\n\t\tif (!isRetry && method===HEAD && options.retryHeadFail && options.retryHeadCodes.includes(response.status))\n\t\t{\n\t\t\t// Retry potentially broken server with GET\n\t\t\tresolve( createRequest(url, auth, GET, options, true) );\n\t\t}\n\t\telse if (method===GET && response.status>=200 && response.status<=299)\n\t\t{\n\t\t\tresolve({ response, stream });\n\t\t}\n\t\telse\n\t\t{\n\t\t\tresolve({ response });\n\t\t}\n\t});\n});\n\n\n\n/**\n * Create a simple response object from that of the \"http\" module.\n * @param {object|Stream} response\n * @param {Array<object>} [redirects]\n * @returns {object}\n * @todo add response time -- https://github.com/sindresorhus/got/issues/874\n */\nconst simplifyResponse = ({headers, statusCode, statusMessage, url}, redirects) =>\n({\n\theaders,\n\tstatus: statusCode,\n\tstatusText: statusMessage,\n\turl: new URL(url),\n\t...(redirects && {redirects}) // only return/destructure object if value is truthy\n});\n\n\n\n/**\n * Convert an HTTP authentication URL or object into a string.\n * @param {URL} url\n * @param {object} auth\n * @returns {string}\n */\nconst stringifyAuth = (url, auth) =>\n{\n\tif (url.password!==\"\" || url.username!==\"\")\n\t{\n\t\treturn `${url.username}:${url.password}`;\n\t}\n\telse if (auth.password!==\"\" || auth.username!==\"\")\n\t{\n\t\treturn `${auth.username}:${auth.password}`;\n\t}\n};\n\n\n\n/**\n * Create an HTTP request and optionally cache the response.\n * @param {URL} url\n * @param {object} auth\n * @param {string} method\n * @param {URLCache} cache\n * @param {object} options\n * @throws {TypeError} non-URL\n * @returns {Promise<object>}\n * @todo use `Promise.try()` instead of `async`\n */\nexport default async (url, auth, method, cache, options) =>\n{\n\tif (!isURL(url))\n\t{\n\t\tthrow new TypeError(BLC_INVALID);\n\t}\n\telse\n\t{\n\t\tconst promise = createRequest(url, auth, method, options);\n\n\t\tif (options.cacheResponses)\n\t\t{\n\t\t\tconst cachedPromise = promise\n\t\t\t.then(({response}) =>\n\t\t\t{\n\t\t\t\t// Replace cached promise\n\t\t\t\t// @todo store in a \"response\" key, so that we can also store a list of all element IDs in the document\n\t\t\t\tcache.set(url, response);\n\n\t\t\t\t// Any final redirect\n\t\t\t\t// @todo store in a \"response\" key, so that we can also store a list of all element IDs in the document\n\t\t\t\tcache.set(response.url, response);\n\n\t\t\t\t// Any intermediary redirects\n\t\t\t\tresponse.redirects.forEach((redirect, i) =>\n\t\t\t\t{\n\t\t\t\t\tconst subsequentRedirects = response.redirects.slice(i + 1);\n\n\t\t\t\t\t// @todo store in a \"response\" key, so that we can also store a list of all element IDs in the document\n\t\t\t\t\tcache.set(redirect.url, {...response, redirects:subsequentRedirects});\n\t\t\t\t});\n\n\t\t\t\treturn response;\n\t\t\t})\n\t\t\t.catch(error => error);  // pass-through\n\n\t\t\t// Make future response available to other requests before completion\n\t\t\t// Will always overwrite previous value\n\t\t\t// @todo store in a \"response\" key, so that we can also store a list of all element IDs in the document\n\t\t\tcache.set(url, cachedPromise);\n\t\t}\n\n\t\treturn promise;\n\t}\n};\n"],"mappings":"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"}